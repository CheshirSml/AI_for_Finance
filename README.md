# AI_for_Finance
–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ RAG –æ—Ç–≤–µ—á–∞—é—â–∏–π –Ω–∞ –æ—Ç–∫—Ä—ã—Ç—ã–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã
# üß† Hybrid RAG + Reranker + Budget Guard + Autotest  
**–†–µ—à–µ–Ω–∏–µ –¥–ª—è AI-for-Finance Hackathon**  
–ë–∞–ª–∞–Ω—Å –∫–∞—á–µ—Å—Ç–≤–∞, —Å–∫–æ—Ä–æ—Å—Ç–∏, —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –≤ –æ–¥–Ω–æ–º –ø–∞–π–ø–ª–∞–π–Ω–µ.

‚úÖ Hybrid RAG (FAISS + BM25)  
‚úÖ Query rewrite + Context compression  
‚úÖ Reranker (Qwen3-Reranker-4B)  
‚úÖ Self-judge autotest  
‚úÖ Token & cost budget guard  
‚úÖ Fail-safe fallback  
‚úÖ –†–µ–∂–∏–º—ã: `eco` / `balanced` / `max-score`  
‚úÖ –ü–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å baseline API  

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `main.py` | –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç –ø–∞–π–ø–ª–∞–π–Ω–∞ |
| `requirements.txt` | –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Python |
| `run_summary.json` | –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: —Ç–æ–∫–µ–Ω—ã, —Å—Ç–æ–∏–º–æ—Å—Ç—å, –≤—Ä–µ–º—è |
| `test_pipeline.py` | –æ—Ç–ª–∞–¥–æ—á–Ω—ã–µ —Ç–µ—Å—Ç—ã |

---

## üéØ –û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ

**production-ready RAG-—Ä–µ—à–µ–Ω–∏–µ** –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–æ—á–Ω—ã—Ö, —ç–∫–æ–Ω–æ–º–∏—á–Ω—ã—Ö –∏ —Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã. –ü–∞–π–ø–ª–∞–π–Ω:

- –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π (`train_data.csv`);
- –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫** (–≤–µ–∫—Ç–æ—Ä–Ω—ã–π + —Ç–µ–∫—Å—Ç–æ–≤—ã–π);
- **–ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å** –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –ø–æ–ª–Ω–æ—Ç—ã;
- **—Ä–∞–Ω–∂–∏—Ä—É–µ—Ç** –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã —Å –ø–æ–º–æ—â—å—é –≤–Ω–µ—à–Ω–µ–≥–æ **reranker'–∞**;
- **—Å–∂–∏–º–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç** –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏;
- –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —Å —É—á—ë—Ç–æ–º **–±—é–¥–∂–µ—Ç–∞ —Ç–æ–∫–µ–Ω–æ–≤**;
- –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∏–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –±—é–¥–∂–µ—Ç–∞ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ **—ç–∫–æ–Ω–æ–º–∏—á–Ω—ã–π fallback**;
- –ø–æ—Å–ª–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ–≥–æ–Ω–∞ **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ** —á–µ—Ä–µ–∑ autotest.

---

## üß© –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Å—Ö–µ–º–∞ –ø–∞–π–ø–ª–∞–π–Ω–∞

```
–í–æ–ø—Ä–æ—Å ‚Üí Query Rewrite ‚Üí Hybrid Retrieve (FAISS + BM25)
                          ‚Üì
                       Reranker (Qwen3-4B)
                          ‚Üì
                    Top-K —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ (K=6)
                          ‚Üì
                   Context Compression (Mistral)
                          ‚Üì
                 Safe LLM Generation (Mistral / LLaMA)
                          ‚Üì
                      –û—Ç–≤–µ—Ç ‚Üí submission.csv
                          ‚Üì
                  Autotest (Self-Judge) ‚Üí diagnostics_autotest.json
```

> –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ `logs/events.jsonl` –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.

## üîÑ Retrieval-Augmented Generation (RAG) –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–∞–π–ø–ª–∞–π–Ω–∞

```mermaid
flowchart TD
    A[‚ùì –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–æ–ø—Ä–æ—Å] --> B[üîÅ Query Rewrite<br/>grok-3-mini]
    B --> C[üìö Hybrid Retrieval<br/>FAISS + BM25]
    C --> D[üß† Reranker<br/>Qwen3-Reranker-4B]
    D --> E[üóú Context Compression<br/>Mistral 24B]
    E --> F[üí¨ Answer Generation<br/>Mistral / LLaMA-3]
    F --> G{‚ö†Ô∏è –û—à–∏–±–∫–∞ –∏–ª–∏ —Å–ª–∞–±—ã–π –æ—Ç–≤–µ—Ç?}
    G -->|–î–∞| H[ü©π Fallback<br/>grok-3-mini]
    G -->|–ù–µ—Ç| I[‚úÖ –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç]
    H --> I
    I --> J[üßæ –õ–æ–≥–∏ –∏ JSON-–æ—Ç—á—ë—Ç—ã<br/>run_summary.json / events.jsonl / diagnostics_autotest.json]
```

---

## üõ†Ô∏è –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã

–ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø–∞–π–ø–ª–∞–π–Ω–∞ —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `RAG_MODE`.

| –†–µ–∂–∏–º | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å | –ú–æ–¥–µ–ª—å | –°—Ç–æ–∏–º–æ—Å—Ç—å | –î–µ—Ç–∞–ª–∏ |
|-------|--------------------|--------|-----------|--------|
| `eco` | –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞, –æ—Ç–ª–∞–¥–∫–∞ | Grok-mini | üí∏ | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è, –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ |
| `balanced` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) | –û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—É—Å–∫ | Mistral-24B | üí∏üí∏ | –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å |
| `max-score` | –§–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥–æ–Ω | LLaMA-3-70B | üí∏üí∏üí∏üí∏ | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å |

> –ü–µ—Ä–µ—Ö–æ–¥ –º–µ–∂–¥—É —Ä–µ–∂–∏–º–∞–º–∏ –º–µ–Ω—è–µ—Ç: –º–æ–¥–µ–ª—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏, —á–∏—Å–ª–æ —á–∞–Ω–∫–æ–≤, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏ –∏ –ª–∏–º–∏—Ç—ã —Ç–æ–∫–µ–Ω–æ–≤.

---

## üß† –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø–∞–π–ø–ª–∞–π–Ω–∞ (—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ)

### 1. **–ó–∞–≥—Ä—É–∑–∫–∞ –∏ —á–∞–Ω–∫–∏–Ω–≥ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π**
- –ò—Å—Ç–æ—á–Ω–∏–∫: `train_data.csv`
- –ö–∞–∂–¥—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —Ä–∞–∑–±–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —á–∞–Ω–∫–∏ –ø–æ **450 —Å–∏–º–≤–æ–ª–æ–≤** —Å **overlap 50**.
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `RecursiveCharacterTextSplitter`.

### 2. **FAISS + BM25: –≥–∏–±—Ä–∏–¥–Ω—ã–π —Ä–µ—Ç—Ä–∏–≤–µ—Ä**
- **FAISS**: –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ `text-embedding-3-small`.
- **BM25**: TF-IDF –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤.
- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è, –¥—É–±–ª–∏–∫–∞—Ç—ã —É–¥–∞–ª—è—é—Ç—Å—è ‚Üí –¥–æ **12 –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤**.

### 3. **Query Rewrite**
- –í–æ–ø—Ä–æ—Å –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–µ—Ç—Å—è –≤ **2 –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –≤–µ—Ä—Å–∏–∏** —á–µ—Ä–µ–∑ `grok-3-mini`.
- –£–ª—É—á—à–∞–µ—Ç –ø–æ–ª–Ω–æ—Ç—É –ø–æ–∏—Å–∫–∞ –∑–∞ —Å—á—ë—Ç —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è.

### 4. **Reranker (Qwen3-Reranker-4B)**
- –í–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–∏—Å: `https://ai-for-finance-hack.up.railway.app/rerank`
- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –≤–æ–ø—Ä–æ—Å + –¥–æ 12 —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `relevance_score`.
- –õ—É—á—à–∏–µ **6 —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤** –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é.
- –ü—Ä–∏ –æ—à–∏–±–∫–µ: –ø–∞–π–ø–ª–∞–π–Ω –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É –±–µ–∑ reranker'–∞.

### 5. **Context Compression**
- –û–±—ä–µ–¥–∏–Ω—è–µ—Ç —Ç–æ–ø-4 —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞.
- –°–∂–∏–º–∞–µ—Ç –¥–æ **6 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π** —á–µ—Ä–µ–∑ `Mistral-24B`.
- –¶–µ–ª—å: —Å–Ω–∏–∑–∏—Ç—å –¥–ª–∏–Ω—É –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ ‚Üí —Å–Ω–∏–∑–∏—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å.

### 6. **Safe Generation —Å Budget Guard**
- –§—É–Ω–∫—Ü–∏—è `safe_generate()`:
  - –°—á–∏—Ç–∞–µ—Ç –≤—Ö–æ–¥/–≤—ã—Ö–æ–¥ —Ç–æ–∫–µ–Ω—ã —á–µ—Ä–µ–∑ `tiktoken`.
  - –û—Ü–µ–Ω–∏–≤–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å (`$0.20 / 1M input`, `$0.20 / 1M output`).
  - –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ `DAILY_BUDGET_USD` ‚Üí **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback** –≤ `eco`-—Ä–µ–∂–∏–º.
- –í—ã–∑—ã–≤–∞–µ—Ç –º–æ–¥–µ–ª—å, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Ç–µ–∫—É—â–µ–º—É —Ä–µ–∂–∏–º—É.

### 7. **Fail-safe Fallback**
- –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏:
  - –û—à–∏–±–∫–∞—Ö API
  - –û—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤
  - –ü—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –±—é–¥–∂–µ—Ç–∞
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ **–¥–µ—à—ë–≤—É—é –º–æ–¥–µ–ª—å `grok-3-mini`**.

### 8. **Autotest (Self-Judge)**
- –ü–æ—Å–ª–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ–≥–æ–Ω–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è `run_autotest()`.
- –ü—Ä–æ–≥–æ–Ω—è–µ—Ç **3 –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞**.
- –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç:
  - –û—Å–Ω–æ–≤–Ω–æ–π –æ—Ç–≤–µ—Ç vs `eco`-fallback
  - –ö–æ—Å–∏–Ω—É—Å–Ω–æ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ (`text-embedding-3-small`)
  - –î–ª–∏–Ω—É –æ—Ç–≤–µ—Ç–æ–≤ –∏ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `diagnostics_autotest.json`.

---

## ‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (`.env`)

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|-----------|------------|------------------------|
| `LLM_API_KEY` | –ö–ª—é—á –¥–ª—è LLM-–∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞ | ‚Äî |
| `EMBEDDER_API_KEY` | –ö–ª—é—á –¥–ª—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ | ‚Äî |
| `RAG_MODE` | –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã | `balanced` |
| `USE_MOCK` | –í–∫–ª—é—á–∏—Ç—å –º–æ–∫-—Ä–µ–∂–∏–º (–±–µ–∑ API) | `0` |
| `USE_RERANKER` | –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å reranker | `1` |
| `DAILY_BUDGET_USD` | –õ–∏–º–∏—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ | `3.0` |
| `LOG_MODE` | –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è | `hackathon` |
| `BASE_URL` | –ë–∞–∑–æ–≤—ã–π URL LLM API | `https://ai-for-finance-hack.up.railway.app/` |
| `RERANKER_URL` | URL reranker API | `https://ai-for-finance-hack.up.railway.app/rerank` |

> –ü—Ä–∏–º–µ—Ä –∑–∞–ø—É—Å–∫–∞:  
> ```bash
> RAG_MODE=eco LOG_MODE=trace python main.py
> ```

---

## üóÑÔ∏è FAISS Cache ‚Äî —É—Å–∫–æ—Ä–µ–Ω–∏–µ –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

- –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è `faiss_index/` (–≤–∫–ª—é—á–∞–µ—Ç `index.faiss` –∏ `index.pkl`).
- –ü—Ä–∏ –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—É—Å–∫–∞—Ö –∏–Ω–¥–µ–∫—Å **–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ**, –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤.
- **–ù–µ –Ω–∞—Ä—É—à–∞–µ—Ç baseline**: –ø–æ–≤–µ–¥–µ–Ω–∏–µ –æ–¥–∏–Ω–∞–∫–æ–≤–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∏ –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—É—Å–∫–∞—Ö.
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞:
  - `USE_MOCK=1` ‚Üí –∏–Ω–¥–µ–∫—Å –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
  - `NO_SAVE_FAISS=1` ‚Üí –æ—Ç–∫–ª—é—á–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  - `REBUILD_FAISS=1` ‚Üí –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å

---

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–∞–π–ø–ª–∞–π–Ω –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç **—á–µ—Ç—ã—Ä–µ —Ä–µ–∂–∏–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è**:

| –†–µ–∂–∏–º | –£—Ä–æ–≤–µ–Ω—å | –§–æ—Ä–º–∞—Ç | –î–ª—è —á–µ–≥–æ |
|-------|--------|--------|----------|
| `prod` | INFO | –ú–∏–Ω–∏–º—É–º | –ó–∞–ø—É—Å–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ |
| `hackathon` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) | DEBUG | –ß–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–π | –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ |
| `ml` | DEBUG | JSON-—Å–æ–±—ã—Ç–∏—è | –ê–Ω–∞–ª–∏–∑ –∫–∞—á–µ—Å—Ç–≤–∞ RAG |
| `trace` | NOTSET | –ú–∞–∫—Å–∏–º—É–º –¥–∞–Ω–Ω—ã—Ö | –ì–ª—É–±–æ–∫–∞—è –æ—Ç–ª–∞–¥–∫–∞ |

–õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤:
- `logs/run_YYYYMMDD_HHMMSS.log` ‚Äî —Ç–µ–∫—Å—Ç–æ–≤—ã–π –ª–æ–≥
- `logs/events.jsonl` ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (–¥–ª—è ML-–∞–Ω–∞–ª–∏–∑–∞)

–ü—Ä–∏–º–µ—Ä –∞–Ω–∞–ª–∏–∑–∞:
```python
import pandas as pd
df = pd.read_json("logs/events.jsonl", lines=True)
df.groupby("event").size()
```

---

## üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
pip install -r requirements.txt
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:
```env
LLM_API_KEY=sk-...
EMBEDDER_API_KEY=sk-...
RAG_MODE=balanced
USE_RERANKER=1
DAILY_BUDGET_USD=3.0
LOG_MODE=hackathon
BASE_URL=https://ai-for-finance-hack.up.railway.app/
RERANKER_URL=https://ai-for-finance-hack.up.railway.app/rerank
```

> ‚ö†Ô∏è **–í–∞–∂–Ω–æ**: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑–Ω—ã–µ –∫–ª—é—á–∏ –¥–ª—è `LLM_API_KEY` –∏ `EMBEDDER_API_KEY`, –µ—Å–ª–∏ API —Ç—Ä–µ–±—É–µ—Ç.

### 3. –ó–∞–ø—É—Å–∫
```bash
python main.py
```

–†–µ–∑—É–ª—å—Ç–∞—Ç:
- `submission.csv` ‚Äî –æ—Ç–≤–µ—Ç—ã –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
- `run_summary.json` ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–æ–∫–µ–Ω–∞–º –∏ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
- `diagnostics_autotest.json` ‚Äî self-judge –æ—Ç—á—ë—Ç
- `logs/` ‚Äî –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏

### 4. –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ —Å —Ä–∞–∑–Ω—ã–º–∏ —Ä–µ–∂–∏–º–∞–º–∏
```bash
# –≠–∫–æ–Ω–æ–º–∏—á–Ω—ã–π –ø—Ä–æ–≥–æ–Ω (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
RAG_MODE=eco python main.py

# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ (–ª–æ–∫–∞–ª—å–Ω–æ, —Ñ–∏–Ω–∞–ª)
RAG_MODE=max-score python main.py

# –ë–µ–∑ reranker‚Äô–∞ (–µ—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
USE_RERANKER=0 python main.py

# –ü–æ–ª–Ω–æ—Å—Ç—å—é –±–µ–∑ API (mock)
USE_MOCK=1 python main.py
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫–∞

### Self-Judge Autotest
–ü–æ—Å–ª–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ–≥–æ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è `run_autotest()`, –∫–æ—Ç–æ—Ä—ã–π:
- –ü—Ä–æ–≥–æ–Ω—è–µ—Ç **3 —Ç–µ—Å—Ç–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–∞**
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç **–¥–≤–∞ –æ—Ç–≤–µ—Ç–∞**: –æ—Å–Ω–æ–≤–Ω–æ–π –∏ `eco`-fallback
- –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –∏—Ö —á–µ—Ä–µ–∑ **—ç–º–±–µ–¥–¥–∏–Ω–≥–∏** (`text-embedding-3-small`)
- –°—á–∏—Ç–∞–µ—Ç **–∫–æ—Å–∏–Ω—É—Å–Ω–æ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ**
- –õ–æ–≥–∏—Ä—É–µ—Ç –¥–ª–∏–Ω—É, –≤—Ä–µ–º—è –∏ ¬´mock score¬ª

–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤:
```json
{
  "question": "–ö–∞–∫ –æ—Ç–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥?",
  "main_answer": "...",
  "fallback_answer": "...",
  "cosine_similarity": 0.87,
  "main_len": 142,
  "fallback_len": 98,
  "main_time_sec": 2.1,
  "mock_score": "high"
}
```


### Mock-—Ä–µ–∂–∏–º (`USE_MOCK=1`)
- –ò–º–∏—Ç–∏—Ä—É–µ—Ç **–≤—Å–µ –≤–Ω–µ—à–Ω–∏–µ –≤—ã–∑–æ–≤—ã**: LLM, —ç–º–±–µ–¥–¥–∏–Ω–≥–∏, reranker
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç **–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã**
- –ù–µ —Ç—Ä–∞—Ç–∏—Ç —Ç–æ–∫–µ–Ω—ã –∏ –Ω–µ —Å–æ–∑–¥–∞—ë—Ç FAISS-–∏–Ω–¥–µ–∫—Å
- –ò–¥–µ–∞–ª–µ–Ω –¥–ª—è **–ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞**

–ü—Ä–∏–º–µ—Ä:
```bash
USE_MOCK=1 LOG_MODE=trace python main.py
```

### –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤
–¢–µ–∫—Å—Ç–æ–≤—ã–π –ª–æ–≥ (`logs/run_*.log`):
```
2025-11-06 05:01:09,174 | INFO | [INFO] –ó–∞–ø—É—Å–∫ –ø–∞–π–ø–ª–∞–π–Ω–∞ | MODE=balanced | LOG_MODE=hackathon
2025-11-06 05:01:09,174 | INFO | [INFO] –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —á–∞–Ω–∫–∏–Ω–≥ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
2025-11-06 05:01:09,363 | INFO | [OK] –ó–∞–≥—Ä—É–∂–µ–Ω–æ 9902 —á–∞–Ω–∫–æ–≤
2025-11-06 05:01:09,364 | INFO | [INFO] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è FAISS + Embeddings
2025-11-06 05:01:10,198 | INFO | [INFO] –ù–∞–π–¥–µ–Ω FAISS –∏–Ω–¥–µ–∫—Å ‚Üí –∑–∞–≥—Ä—É–∑–∫–∞ 'faiss_index'
2025-11-06 05:01:10,658 | INFO | [OK] FAISS –≥–æ—Ç–æ–≤
2025-11-06 05:01:10,658 | DEBUG | Init BM25
2025-11-06 05:01:10,881 | INFO | [INFO] Q: –ö–∞–∫ –ø—Ä–æ—Å—Ä–æ—á–∫–∞ –ø–æ ¬´–±–µ—Å–ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–º—É¬ª –∑–∞–π–º—É —Å–∫–∞–∂–µ—Ç—Å—è –Ω–∞ –ø–µ—Ä–µ–ø–ª–∞—Ç–µ/–ü–°–ö?
2025-11-06 05:01:20,387 | DEBUG | Rewrite variants: ['–ö–∞–∫ –ø—Ä–æ—Å—Ä–æ—á–∫–∞ –ø–æ ¬´–±–µ—Å–ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–º—É¬ª –∑–∞–π–º—É —Å–∫–∞–∂–µ—Ç—Å—è –Ω–∞ –ø–µ—Ä–µ–ø–ª–∞—Ç–µ/–ü–°–ö?', '–í–æ—Ç –¥–≤–∞ –∫–æ—Ä–æ—Ç–∫–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞:', '1. **–ö–∞–∫ –ø—Ä–æ—Å—Ä–æ—á–∫–∞ –ø–æ –±–µ—Å–ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–º—É –∫—Ä–µ–¥–∏—Ç—É –≤–ª–∏—è–µ—Ç –Ω–∞ –ø–µ—Ä–µ–ø–ª–∞—Ç—É?**']
2025-11-06 05:01:21,312 | DEBUG | Retrieved 12 docs for query='–ö–∞–∫ –ø—Ä–æ—Å—Ä–æ—á–∫–∞ –ø–æ ¬´–±–µ—Å–ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–º—É¬ª –∑–∞–π–º—É —Å–∫–∞–∂–µ—Ç—Å—è –Ω–∞ –ø–µ—Ä–µ–ø–ª–∞—Ç–µ/–ü–°–ö?'
2025-11-06 05:01:21,759 | DEBUG | Retrieved 11 docs for query='–í–æ—Ç –¥–≤–∞ –∫–æ—Ä–æ—Ç–∫–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞:'
2025-11-06 05:01:22,200 | DEBUG | Retrieved 12 docs for query='1. **–ö–∞–∫ –ø—Ä–æ—Å—Ä–æ—á–∫–∞ –ø–æ –±–µ—Å–ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–º—É –∫—Ä–µ–¥–∏—Ç—É –≤–ª–∏—è–µ—Ç –Ω–∞ –ø–µ—Ä–µ–ø–ª–∞—Ç—É?**'
2025-11-06 05:01:22,201 | DEBUG | [RERANK] Sending 12 docs to reranker
2025-11-06 05:01:29,755 | DEBUG | Reranker returned 12 docs for '–ö–∞–∫ –ø—Ä–æ—Å—Ä–æ—á–∫–∞ –ø–æ ¬´–±–µ—Å–ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–º—É¬ª –∑–∞–π–º—É ...'
2025-11-06 05:01:29,760 | DEBUG | [RERANK] Top docs selected: 6
2025-11-06 05:01:34,417 | DEBUG | Compressed context 303 chars
2025-11-06 05:01:40,933 | INFO | [OK] Answer: –ù–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –≤—ã–≤–æ–¥, —á—Ç–æ –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–º–µ...
...
2025-11-06 07:55:38,365 | INFO | [INFO] –ó–∞–ø—É—Å–∫–∞—é self-test
...
2025-11-06 07:56:46,988 | WARNING | Fallback ‚Üí baseline grok-mini
2025-11-06 07:56:59,900 | INFO | [OK] –ê–≤—Ç–æ—Ç–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω
2025-11-06 07:56:59,901 | INFO | [OK] –ì–æ—Ç–æ–≤–æ | cost‚âà0.0517$ | tokens=106454+151958
```

JSON-–ª–æ–≥ (`logs/events.jsonl`):
```json
{"time": 1762404980.1972568, "event": "generation", "model": "openrouter/mistralai/mistral-small-3.2-24b-instruct", "tokens_in": 191, "tokens_out": 154}
{"time": 1762404986.9321108, "event": "autotest", "q": "–ö–∞–∫ –∏–∑–º–µ–Ω–∏—Ç—å –ª–∏–º–∏—Ç –∫–∞—Ä—Ç—ã?", "answer_len": 382, "fallback_len": 452, "sim": null}
{"time": 1762404998.4041812, "event": "rerank", "q": "–ö–∞–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–æ—Å—Ç—É–ø?", "docs_used": 6}
{"time": 1762405006.9869704, "event": "generation", "model": "openrouter/mistralai/mistral-small-3.2-24b-instruct", "tokens_in": 183, "tokens_out": 316}
{"time": 1762405019.8970237, "event": "autotest", "q": "–ö–∞–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–æ—Å—Ç—É–ø?", "answer_len": 715, "fallback_len": 315, "sim": null}
{"time": 1762405019.8990235, "event": "autotest_rerank", "reranker": "Qwen3-Reranker-4B", "status": "active"}
```

–ê–Ω–∞–ª–∏–∑ –≤ Colab / Notebook:
```python
import pandas as pd
events = pd.read_json("logs/events.jsonl", lines=True)
events.groupby("event").size()
events[events.event == "generation"][["model", "input_tokens", "output_tokens"]].describe()
```

---


## ‚ùì –ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã (FAQ)

### Q: –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ reranker –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω?
A: –ü–∞–π–ø–ª–∞–π–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç –±–µ–∑ –Ω–µ–≥–æ. –ß—Ç–æ–±—ã –æ—Ç–∫–ª—é—á–∏—Ç—å —è–≤–Ω–æ:
```bash
USE_RERANKER=0 python main.py
```

### Q: –ö–∞–∫ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å FAISS-–∏–Ω–¥–µ–∫—Å?
A: –£–¥–∞–ª–∏—Ç–µ –ø–∞–ø–∫—É –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –∑–∞–Ω–æ–≤–æ:
```bash
rm -rf faiss_index/
python main.py
```

### Q: –ú–æ–∂–Ω–æ –ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å autotest?
A: –î–∞ ‚Äî –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å—Ç—Ä–æ–∫—É `run_autotest()` –≤ –∫–æ–Ω—Ü–µ `main.py`.

### Q: –ü–æ—á–µ–º—É –æ—Ç–≤–µ—Ç—ã –∫–æ—Ä–æ—Ç–∫–∏–µ –≤ `eco`-—Ä–µ–∂–∏–º–µ?
A: –≠—Ç–æ –æ–∂–∏–¥–∞–µ–º–æ: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `grok-3-mini` —Å –∂—ë—Å—Ç–∫–∏–º –ª–∏–º–∏—Ç–æ–º —Ç–æ–∫–µ–Ω–æ–≤. –î–ª—è –ø–æ–ª–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ—Å—å –Ω–∞ `balanced`.

### Q: –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏ –±—é–¥–∂–µ—Ç?
A: –°–º–æ—Ç—Ä–∏ `run_summary.json` 

---

## üìé –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä `.env`
```env
LLM_API_KEY=sk-llm-xxxxxxxx
EMBEDDER_API_KEY=sk-emb-xxxxxxxx
RAG_MODE=balanced
USE_RERANKER=1
USE_MOCK=0
DAILY_BUDGET_USD=3.0
LOG_MODE=hackathon
BASE_URL=https://ai-for-finance-hack.up.railway.app/
RERANKER_URL=https://ai-for-finance-hack.up.railway.app/rerank
```

### –ü—Ä–∏–º–µ—Ä `run_summary.json`
```json
{
  "tokens_in": 106454,
  "tokens_out": 151958,
  "cost": 0.0516824,
  "time": 10550.726569414139
}
```
